# Optional Caddy override file for automatic Let's Encrypt HTTPS support.
# Usage: docker compose -f docker-compose.yml -f docker-compose.caddy.yml up -d
services:
  nginx:
    # We stop the default nginx service entirely
    profiles: ["disabled"]

  caddy:
    image: caddy:2.9.1-alpine
    container_name: clipfeed-proxy
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
      web:
        condition: service_started
      minio:
        condition: service_healthy
    networks:
      - frontend
    environment:
      SERVER_NAME: "${SERVER_NAME:-:80}"
      API_UPSTREAM: "${API_UPSTREAM:-api:8080}"
      WEB_UPSTREAM: "${WEB_UPSTREAM:-web:3000}"
      MINIO_UPSTREAM: "${MINIO_UPSTREAM:-minio:9000}"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: "${CADDY_MEMORY:-128m}"

volumes:
  caddy_data:
  caddy_config:
