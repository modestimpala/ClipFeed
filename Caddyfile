{
	admin off
}

# The address to listen on. Defaults to :80
# Set SERVER_NAME=clipfeed.example.com to automatically enable Let's Encrypt HTTPS
{$SERVER_NAME::80} {
	# API
	handle /api/* {
		reverse_proxy {$API_UPSTREAM:api:8080}
	}

	# Health check
	handle /health {
		reverse_proxy {$API_UPSTREAM:api:8080}
	}

	# MinIO Direct Access
	handle_path /storage/* {
		reverse_proxy {$MINIO_UPSTREAM:minio:9000} {
			header_up Host {http.reverse_proxy.upstream.hostport}
			# Forward byte-range headers so MinIO returns partial content (206).
			# Caddy passes all request headers by default, but being explicit here
			# matches nginx behaviour and prevents future middleware from eating them.
			header_up Range {http.request.header.Range}
			header_up If-Range {http.request.header.If-Range}
			# Stream response bytes to the client without buffering.
			# Required for partial-content (206) responses -- iOS Safari stalls
			# on video seeks when the proxy buffers the full response first.
			flush_interval -1
		}

		# CORS
		header Access-Control-Allow-Origin *
		header Access-Control-Allow-Methods "GET, HEAD, OPTIONS"
		header Accept-Ranges bytes
		header X-Content-Type-Options "nosniff"
	}

	# Web Frontend
	handle /* {
		reverse_proxy {$WEB_UPSTREAM:web:3000}
	}

	# Security Headers
	header X-Content-Type-Options "nosniff"
	header X-Frame-Options "DENY"
	header Referrer-Policy "strict-origin-when-cross-origin"
	header Permissions-Policy "camera=(), microphone=(), geolocation=()"
}
